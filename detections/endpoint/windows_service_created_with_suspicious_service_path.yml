name: Windows Service Created with Suspicious Service Path
id: 429141be-8311-11eb-adb6-acde48001122
version: 4
date: '2022-11-14'
author: Teoderick Contreras, Mauricio Velazco, Splunk,TheLawsOfChaos, Github
type: TTP
datamodel: []
description: The following analytics uses Windows Event Id 7045, `New Service Was Installed`,
  to identify the creation of a Windows Service where the service binary path path
  is located in a non-common Service folder in Windows. Red Teams and adversaries
  alike may create malicious Services for lateral movement or remote code execution
  as well as persistence and execution. The Clop ransomware has also been seen in
  the wild abusing Windows services.
search: ' `wineventlog_system` EventCode=7045  ImagePath = "*.exe" NOT (ImagePath
  IN ("*:\\Windows\\*", "*:\\Program File*", "*:\\Programdata\\*", "*%systemroot%\\*"))
  | stats count min(_time) as firstTime max(_time) as lastTime by EventCode ImagePath
  ServiceName StartType ServiceType dest user_id | `security_content_ctime(firstTime)`
  | `security_content_ctime(lastTime)` | `windows_service_created_with_suspicious_service_path_filter`'
how_to_implement: To successfully implement this search, you need to be ingesting
  logs with the Service name, Service File Name Service Start type, and Service Type
  from your endpoints.
known_false_positives: Legitimate applications may install services with uncommon
  services paths.
references:
- https://www.mandiant.com/resources/fin11-email-campaigns-precursor-for-ransomware-data-theft
- https://blog.virustotal.com/2020/11/keep-your-friends-close-keep-ransomware.html
tags:
  analytic_story:
  - Clop Ransomware
  - Active Directory Lateral Movement
  - Brute Ratel C4
  - Qakbot
  confidence: 80
  context:
  - Source:Endpoint
  - Stage:Privilege Escalation
  - Stage:Lateral Movement
  dataset:
  - https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/malware/clop/clop_a/windows-system.log
  impact: 70
  kill_chain_phases:
  - Exploitation
  message: A service $ImagePath$ was created from a non-standard path using
    $ServiceName$
  mitre_attack_id:
  - T1569
  - T1569.002
  observable:
  - name: dest
    type: Hostname
    role:
    - Victim
  - name: ImagePath
    type: Other
    role:
    - Other
  - name: Service_Name
    type: Other
    role:
    - Other
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - EventCode
  - ImagePath
  - ServiceType
  - _time
  - ServiceName
  - StartType
  - dest
  risk_score: 56
  security_domain: endpoint
  asset_type: Endpoint