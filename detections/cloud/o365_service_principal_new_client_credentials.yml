name: O365 Service Principal New Client Credentials
id: a1b229e9-d962-4222-8c62-905a8a010453
version: 1
date: '2023-08-31'
author: Mauricio Velazco, Splunk
status: production
type: TTP
description: The following analytic identifies the addition of new credentials for Service
  Principals in addition to existing legitimate credentials within a Office 365 tenant.
  These credentials include both x509 certificates and passwords. Adversaries
  and red teams alike who have obtained privileged access may add credentials
  to Service Principals and abuse them to obtain access to Office 365 mailboxes. 
data_source: []
search: ' `o365_management_activity` Workload=AzureActiveDirectory Operation="Update application*Certificates and secrets management "
  | stats values(object) as object by _time, UserId, ModifiedProperties{}.NewValue
  | `o365_service_principal_new_client_credentials_filter`'
how_to_implement: You must install the Splunk Microsoft Office 365 Add-on and ingest Office 365 management activity events.
known_false_positives: Service Principal client credential modifications may be part
  of legitimate administrative operations. Filter as needed.
references:
- https://attack.mitre.org/techniques/T1098/001/
- https://www.mandiant.com/resources/blog/remediation-and-hardening-strategies-for-microsoft-365-to-defend-against-unc2452
- https://microsoft.github.io/Azure-Threat-Research-Matrix/Persistence/AZT501/AZT501-2/ 
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Cloud%20-%20Azure%20Pentest.md#add-credentials-to-all-enterprise-applications 
tags:
  analytic_story:
  - UPDATE_STORY_NAME
  asset_type: Office 365
  atomic_guid:
  - UPDATE atomic_guid
  confidence: 50
  impact: 70
  message: New credentials added for Service Principal $object$
  mitre_attack_id:
  - T1098
  - T1098.001
  observable:
  - name: object
    type: User
    role:
    - Victim
  - name: UserId
    type: User
    role:
    - Attacker
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  risk_score: 35
  required_fields:
  - _time
  - Workload
  - Operation
  - object
  - UserId
  security_domain: identity
tests:
- name: True Positive Test
  attack_data:
  - data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1098.001/o365_service_principal_credentials/o365_service_principal_credentials.log
    sourcetype: o365:management:activity
    source: o365